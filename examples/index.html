<!DOCTYPE html>
<html>
<head>
    <title>iiif-av-component: test</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />
    <link rel="stylesheet" type="text/css" href="css/iiif-av-component.css" />
    <link rel="stylesheet" type="text/css" href="styles.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.4.1/core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsviews/0.9.76/jsviews.min.js"></script>

    <script src="ui.js"></script>
    <script src="js/base-component.js"></script>
    <script src="js/iiif-av-component.js"></script>
    <script src="https://rawgit.com/viewdir/iiif-tree-component/dev/dist/iiif-tree-component.js"></script>

    <!-- todo: use manifold.bundle.js -->
    <script src="https://rawgit.com/viewdir/manifesto/dev/dist/client/manifesto.bundle.js"></script>
    <script src="https://rawgit.com/viewdir/manifold/dev/dist/manifold.js"></script>

    <!-- <script src="js/manifold.bundle.js"></script> -->
</head>
<body>

    <div class="testFixtureSelection">
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/bl/01_gapless_audio.json">Load Test 1</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/bl/02_gapless_video.json">Load Test 2</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/bl/03_synchronised_video.json">Load Test 3</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/bl/04_synchronised_av.json">Load Test 4</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/bl/05_synchronised_av_text.json">Load Test 5</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/iiif/fire.json">Load Test 6</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/iiif/mahler-symphony.json">Load Test 7</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/iiif/lunchroom-manners.json">Load Test 8</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/iiif/02.json">Load Test 10</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/iiif/16.json">Load Test 11</button>
    </div>
    <input type="text" name="manifestInput" id="manifestInput"/>
    <button id="parseManifestButton">Parse Manifest</button>
    <button id="viewManifestButton">View Manifest</button>

    <hr>

    <h3 class="title"></h3>
    <div class="description"></div>

    <div class="canvasNavigationContainer"></div>

    <div id="av" class="playerContainer iiif-av-component">
        loading...
    </div>

    <div id="tree" class="iiif-tree-component"></div>

    <button id="toggleLogsButton">Show / Hide Logs</button>
    <div class="logContainer">
        <textarea></textarea>
        <button id="clearLogsButton">Clear</button>
    </div>

    <script>

        var helper, avcomponent, treecomponent;
        
        function resize() {
            // resizing stuff outside of the component
        }

        window.onresize = function() {
            resize();
        }

        function loadManifest(manifest, successcb, errorcb) {

            Manifold.loadManifest({
                iiifResourceUri: manifest,
                collectionIndex: 0,
                manifestIndex: 0,
                sequenceIndex: 0,
                canvasIndex: 0
            }).then(function(h) {

                helper = h;

                avcomponent.set({
                    helper: helper
                });

                treecomponent.set({
                    branchNodesSelectable: false,
                    helper: helper
                });

                successcb(helper);

                resize();

            }).catch(function(e) {
                errorcb(e);
            });
        }

        $(function() {

            initUI();

            avcomponent = new IIIFComponents.AVComponent({
                target: document.querySelector('#av')
            });

            avcomponent.on('log', function(message) {
                logMessage(message);
            });

            treecomponent = new IIIFComponents.TreeComponent({
                target: document.querySelector('#tree')
            });

            function getCanvasInstanceByID(canvasID) {
                cleanCanvasID = canvasID.replace('http://', '').replace('https://', '').split('#')[0];
                for (var i = 0; i < avcomponent.canvasInstances.length; i++) {
                    var cleanInstanceID = avcomponent.canvasInstances[i].data.id.replace('http://', '').replace('https://', '').split('#')[0];
                    if (cleanInstanceID == cleanCanvasID) {
                        return avcomponent.canvasInstances[i];
                    }
                }

                return null;
            } 

            function showCanvas(canvasId) {
                for (var i = 0; i < avcomponent.canvasInstances.length; i++) {
                    avcomponent.canvasInstances[i].pauseCanvas();
                }
                $('.playerContainer .player').hide();
                getCanvasInstanceByID(canvasId).$playerElement.show();
            }

            treecomponent.on('treeNodeSelected', function(node) {
                console.log('selected: ' + node.label);

                var canvasId = node.data.canvases[0];
                var canvas = helper.getCanvasById(canvasId);

                if (canvas) {
                    
                    showCanvas(canvas.id);

                    var canvasInstance = getCanvasInstanceByID(canvasId);

                    var temporal = /t=([^&]+)/g.exec(canvasId);
                    
                    if (temporal && temporal[1]) {
                        var rangeTiming = temporal[1].split(',');
                        canvasInstance.setCurrentTime(rangeTiming[0]);
                        canvasInstance.playCanvas();
                    }

                    logMessage('SELECT RANGE: '+ node.label);
                } else {
                    logMessage('ERROR: Could not find canvas for range '+ node.label);
                }
            });

        });

    </script>
</body>
</html>