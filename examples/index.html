<!DOCTYPE html>
<html>
<head>
    <title>iiif-av-component: test</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />
    <link rel="stylesheet" type="text/css" href="css/iiif-av-component.css" />
    <link rel="stylesheet" type="text/css" href="styles.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.4.1/core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsviews/0.9.76/jsviews.min.js"></script>

    <script src="js/base-component.js"></script>
    <script src="js/iiif-av-component.js"></script>
    <script src="https://rawgit.com/viewdir/iiif-tree-component/master/dist/iiif-tree-component.js"></script>

    <!-- <script src="https://rawgit.com/viewdir/manifesto/dev/dist/client/manifesto.bundle.js"></script>
    <script src="https://rawgit.com/viewdir/manifold/dev/dist/manifold.js"></script> -->

    <script src="js/manifold.bundle.js"></script>
</head>
<body>

    <div class="testFixtureSelection">
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/bl/01_gapless_audio.json">Load Test 1</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/bl/02_gapless_video.json">Load Test 2</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/bl/03_synchronised_video.json">Load Test 3</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/bl/04_synchronised_av.json">Load Test 4</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/bl/05_synchronised_av_text.json">Load Test 5</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/iiif/fire.json">Load Test 6</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/iiif/mahler-symphony.json">Load Test 7</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/iiif/lunchroom-manners.json">Load Test 8</button>
        <button class="testFixture" data-json="https://britishlibrary.github.io/iiif-av-samples/symphony/manifest.json">Load Test 9</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/iiif/02.json">Load Test 10</button>
        <button class="testFixture" data-json="https://viewdir.github.io/iiif-av-component/examples/data/iiif/16.json">Load Test 11</button>
    </div>
    <input type="text" name="manifestInput" id="manifestInput"/>
    <button id="parseManifestButton">Parse Manifest</button>
    <button id="viewManifestButton">View Manifest</button>

    <hr>

    <h3 class="title"></h3>
    <div class="description"></div>

    <div class="canvasNavigationContainer"></div>

    <div id="av" class="playerContainer iiif-av-component">
        loading...
    </div>

    <div id="tree" class="iiif-tree-component"></div>

    <button id="toggleLogsButton">Show / Hide Logs</button>
    <div class="logContainer">
        <textarea></textarea>
        <button id="clearLogsButton">Clear</button>
    </div>

    <script>

        var helper, avcomponent, treecomponent;
        
        function resize() {
            // resizing stuff outside of the component
        }

        window.onresize = function() {
            resize();
        }

        function loadManifest(manifest, successcb, errorcb) {

            Manifold.loadManifest({
                iiifResourceUri: manifest,
                collectionIndex: 0,
                manifestIndex: 0,
                sequenceIndex: 0,
                canvasIndex: 0
            }).then(function(h) {

                helper = h;

                avcomponent.set({
                    helper: helper,
                    defaultCanvasHeight: 400,
                    defaultCanvasWidth: 600
                });

                treecomponent.set({
                    branchNodesSelectable: false,
                    helper: helper
                });

                successcb(helper);

                resize();

            }).catch(function(e) {
                errorcb(e);
            });
        }

        $(function() {

            avcomponent = new IIIFComponents.AVComponent({
                target: document.querySelector('#av')
            });

            avcomponent.on('log', function(message) {
                logMessage(message);
            });

            treecomponent = new IIIFComponents.TreeComponent({
                target: document.querySelector('#tree')
            });

            function getCanvasInstanceByID(canvasID) {
                cleanCanvasID = canvasID.replace('http://', '').replace('https://', '').split('#')[0];
                for (var i = 0; i < avcomponent.canvasInstances.length; i++) {
                    var cleanInstanceID = avcomponent.canvasInstances[i].data.id.replace('http://', '').replace('https://', '').split('#')[0];
                    if (cleanInstanceID == cleanCanvasID) {
                        return avcomponent.canvasInstances[i];
                    }
                }

                return null;
            } 

            function showCanvas(canvasId) {
                for (var i = 0; i < avcomponent.canvasInstances.length; i++) {
                    avcomponent.canvasInstances[i].pauseCanvas();
                }
                $('.playerContainer .player').hide();
                getCanvasInstanceByID(canvasId).$playerElement.show();
            }

            function initCanvasNavigation(canvases) {

                for (var i=0; i<canvases.length; i++) {
                    
                    var canvasLabel = i+1;
                    var canvasNavigationButton = $('<button class="canvasNavigationButton" data-canvas-id="'+ canvases[i].id +'">Canvas '+ canvasLabel +'</button>');
                    
                    canvasNavigationButton.click(function() {
                        navigateToCanvas( $(this).attr('data-canvas-id') );
                    });

                    $('.canvasNavigationContainer').append(canvasNavigationButton);
                    $('.canvasNavigationContainer').show();
                }

                window.setTimeout(function() {
                    var firstID = avcomponent.canvasInstances[0].data.id;
                    navigateToCanvas(firstID);
                }, 10);
                
            }

            function navigateToCanvas(canvasID) {
                for (var i = 0; i < avcomponent.canvasInstances.length; i++) {
                    avcomponent.canvasInstances[i].pauseCanvas();
                }
                $('.playerContainer .player').hide();
                getCanvasInstanceByID(canvasID).$playerElement.show();
            }

            function showWorkingIndicator(targetElement) {
                var workingIndicator = $('<div class="workingIndicator">Waiting ...</div>');
                if (targetElement.find('.workingIndicator').length == 0) {
                    targetElement.append(workingIndicator);
                }
                //console.log('show working');
            }

            function hideWorkingIndicator() {
                $('.workingIndicator').remove();
                //console.log('hide working');
            }

            function logMessage(message, logObj) {
                if (logObj) {
                    //console.log(message, logObj);
                } else {
                    //console.log(message);
                }

                $('.logContainer textarea')[0].value = $('.logContainer textarea')[0].value += '\n'+ message;
            }

            function clearLogs() {
                $('.logContainer textarea')[0].value = '';
            }

            $('#manifestInput').val('');

            $('#clearLogsButton').click(clearLogs);

            $('#toggleLogsButton').click(function() {
                $('.logContainer').toggle();
            });

            $('.testFixture').click(function() {
                $('#manifestInput').val( $(this).data('json') );
                $('#parseManifestButton').click();
            });

            $('#viewManifestButton').click(function() {
                var absoluteManifestURL = $('#manifestInput').val();
                window.open(absoluteManifestURL, '_blank', 'location=yes,height=600,width=580,scrollbars=yes,status=yes');
            });
            
            $('#parseManifestButton').click(function() {

                var manifestURL = $('#manifestInput').val();

                loadManifest(manifestURL, function(helper) {

                    clearLogs();

                    $('.title').text(helper.getLabel());
                    $('.description').text(helper.getDescription());

                    logMessage('SUCCESS: Manifest data loaded.', helper.manifest);

                    var canvases = helper.getCanvases();

                    if (canvases.length > 1) {
                        initCanvasNavigation(canvases);
                    } else {
                        $('.canvasNavigationContainer').hide();
                    }
                    
                }, function(error) {

                    $('.title').text('ERROR: Could not load manifest data.');
                    $('.description').text('');
                    
                    logMessage('ERROR: Could not load manifest data.', error);

                });

            });

            treecomponent.on('treeNodeSelected', function(node) {
                console.log('selected: ' + node.label);

                var canvasId = node.data.canvases[0];
                var canvas = helper.getCanvasById(canvasId);

                if (canvas) {
                    
                    showCanvas(canvas.id);

                    var canvasInstance = getCanvasInstanceByID(canvasId);

                    var temporal = /t=([^&]+)/g.exec(canvasId);
                    
                    if (temporal && temporal[1]) {
                        var rangeTiming = temporal[1].split(',');
                        canvasInstance.setCurrentTime(rangeTiming[0]);
                        canvasInstance.playCanvas();
                    }

                    logMessage('SELECT RANGE: '+ node.label);
                } else {
                    logMessage('ERROR: Could not find canvas for range '+ node.label);
                }
            });

        });

    </script>
</body>
</html>