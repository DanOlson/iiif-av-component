// iiif-av-component v1.1.0 https://github.com/viewdir/iiif-av-component#readme
!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.iiifAvComponent=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){(function(global){var IIIFComponents,__extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(IIIFComponents){var AVComponent=function(_super){function AVComponent(options){var _this=_super.call(this,options)||this;return _this._defaultCanvasHeight=400,_this._defaultCanvasWidth=600,_this.canvasInstances=[],_this._init(),_this._resize(),_this}return __extends(AVComponent,_super),AVComponent.prototype._init=function(){var success=_super.prototype._init.call(this);return success||console.error("Component failed to initialise"),success},AVComponent.prototype.data=function(){return{helper:null}},AVComponent.prototype.set=function(data){this.options.data=data,this._reset(),this._render(),this._resize()},AVComponent.prototype._reset=function(){for(var i=0;i<this.canvasInstances.length;i++)window.clearInterval(this.canvasInstances[i].highPriorityInterval),window.clearInterval(this.canvasInstances[i].lowPriorityInterval),window.clearInterval(this.canvasInstances[i].canvasClockInterval);this.canvasInstances=[]},AVComponent.prototype._render=function(){this._$element.empty();for(var canvases=this._getCanvases(),i=0;i<canvases.length;i++)this._initCanvas(canvases[i])},AVComponent.prototype._getCanvases=function(){return this.options.data.helper.getCanvases()},AVComponent.prototype._initCanvas=function(canvas){var $player=$('<div class="player"></div>'),$canvasContainer=$('<div class="canvasContainer"></div>'),$timelineContainer=$('<div class="timelineContainer"></div>'),$timelineItemContainer=$('<div class="timelineItemContainer"></div>'),$controlsContainer=$('<div class="controlsContainer"></div>'),$playButton=$('<button class="playButton">Play</button>'),$pauseButton=$('<button class="pauseButton">Pause</button>'),$timingControls=$('<span>Current Time: <span class="canvasTime"></span> / Duration: <span class="canvasDuration"></span></span>');$controlsContainer.append($playButton,$pauseButton,$timingControls),$player.append($canvasContainer,$timelineContainer,$timelineItemContainer,$controlsContainer),this._$element.append($player);var canvasInstance=new IIIFComponents.CanvasInstance(canvas),canvasWidth=canvas.getWidth(),canvasHeight=canvas.getHeight();canvasWidth?canvasInstance.canvasWidth=canvasWidth:canvasInstance.canvasWidth=this._defaultCanvasWidth,canvasHeight?canvasInstance.canvasHeight=canvasHeight:canvasInstance.canvasHeight=this._defaultCanvasHeight,canvasInstance.$playerElement=$player,canvasInstance.logMessage=this._logMessage.bind(this),$timelineContainer.slider({value:0,step:.01,orientation:"horizontal",range:"min",max:canvasInstance.canvasClockDuration,animate:!1,create:function(evt,ui){},slide:function(evt,ui){canvasInstance.setCurrentTime(ui.value)},stop:function(evt,ui){}}),this.canvasInstances.push(canvasInstance),canvasInstance.initContents(),$playButton.on("click",function(){canvasInstance.playCanvas()}),$pauseButton.on("click",function(){canvasInstance.pauseCanvas()}),canvasInstance.setCurrentTime(0),$timingControls.find(".canvasDuration").text(IIIFComponents.AVComponentUtils.Utils.formatTime(canvasInstance.canvasClockDuration)),this._logMessage("CREATED CANVAS: "+canvasInstance.canvasClockDuration+" seconds, "+canvasInstance.canvasWidth+" x "+canvasInstance.canvasHeight+" px.")},AVComponent.prototype._logMessage=function(message){this.fire(AVComponent.Events.LOG,message)},AVComponent.prototype._resize=function(){for(var i=0;i<this.canvasInstances.length;i++){var canvasInstance=this.canvasInstances[i];if(canvasInstance.$playerElement){var $canvasContainer=canvasInstance.$playerElement.find(".canvasContainer"),$timelineContainer=canvasInstance.$playerElement.find(".timelineContainer"),containerWidth=$canvasContainer.width();if(containerWidth){$timelineContainer.width(containerWidth);var resizeFactorY=containerWidth/canvasInstance.canvasWidth;$canvasContainer.height(canvasInstance.canvasHeight*resizeFactorY)}}}},AVComponent}(_Components.BaseComponent);IIIFComponents.AVComponent=AVComponent}(IIIFComponents||(IIIFComponents={})),function(IIIFComponents){var AVComponent;!function(AVComponent){var Events=function(){function Events(){}return Events.LOG="log",Events}();AVComponent.Events=Events}(AVComponent=IIIFComponents.AVComponent||(IIIFComponents.AVComponent={}))}(IIIFComponents||(IIIFComponents={})),function(g){g.IIIFComponents?g.IIIFComponents.AVComponent=IIIFComponents.AVComponent:g.IIIFComponents=IIIFComponents}(global);var IIIFComponents;!function(IIIFComponents){var CanvasInstance=function(){function CanvasInstance(canvas){this._highPriorityFrequency=25,this._lowPriorityFrequency=100,this._canvasClockFrequency=25,this.$playerElement=null,this.canvasClockDuration=0,this.canvasClockStartDate=0,this.canvasClockTime=0,this.canvasHeight=0,this.canvasWidth=0,this.data=null,this.isPlaying=!1,this.isStalled=!1,this.stallRequestedBy=[],this.wasPlaying=!1,this.data=canvas,this.canvasClockDuration=canvas.getDuration()}return CanvasInstance.prototype.initContents=function(){if(this.data){this._mediaElements=[];for(var mediaItems=this.data.__jsonld.content[0].items,i=0;i<mediaItems.length;i++){var mediaSource,mediaItem=mediaItems[i];if("TextualBody"==mediaItem.body.type)mediaSource=mediaItem.body.value;else if(Array.isArray(mediaItem.body)&&"Choice"==mediaItem.body[0].type){var tmpItem=mediaItem;mediaItem.body=tmpItem.body[0].items[0],mediaSource=mediaItem.body.id.split("#")[0]}else mediaSource=mediaItem.body.id.split("#")[0];var xywh,spatial=/xywh=([^&]+)/g.exec(mediaItem.target),temporal=/t=([^&]+)/g.exec(mediaItem.target);xywh=spatial&&spatial[1]?spatial[1].split(","):[0,0,this.canvasWidth,this.canvasHeight];var t;t=temporal&&temporal[1]?temporal[1].split(","):[0,this.canvasClockDuration];var ot,positionLeft=parseInt(xywh[0]),positionTop=parseInt(xywh[1]),mediaWidth=parseInt(xywh[2]),mediaHeight=parseInt(xywh[3]),startTime=parseInt(t[0]),endTime=parseInt(t[1]),percentageTop=this._convertToPercentage(positionTop,this.canvasHeight),percentageLeft=this._convertToPercentage(positionLeft,this.canvasWidth),percentageWidth=this._convertToPercentage(mediaWidth,this.canvasWidth),percentageHeight=this._convertToPercentage(mediaHeight,this.canvasHeight),temporalOffsets=/t=([^&]+)/g.exec(mediaItem.body.id);ot=temporalOffsets&&temporalOffsets[1]?temporalOffsets[1].split(","):[null,null];var offsetStart=ot[0]?parseInt(ot[0]):ot[0],offsetEnd=ot[1]?parseInt(ot[1]):ot[1],itemData={type:mediaItem.body.type,source:mediaSource,start:startTime,end:endTime,top:percentageTop,left:percentageLeft,width:percentageWidth,height:percentageHeight,startOffset:offsetStart,endOffset:offsetEnd,active:!1};this._renderMediaElement(itemData)}}},CanvasInstance.prototype._convertToPercentage=function(pixelValue,maxValue){var percentage=pixelValue/maxValue*100;return percentage},CanvasInstance.prototype._renderMediaElement=function(data){var mediaElement;switch(data.type){case"Image":mediaElement=$('<img class="anno" src="'+data.source+'" />');break;case"Video":mediaElement=$('<video class="anno" src="'+data.source+'" />');break;case"Audio":mediaElement=$('<audio class="anno" src="'+data.source+'" />');break;case"TextualBody":mediaElement=$('<div class="anno">'+data.source+"</div>");break;default:return}if(mediaElement.css({top:data.top+"%",left:data.left+"%",width:data.width+"%",height:data.height+"%"}).hide(),data.element=mediaElement,"Video"==data.type||"Audio"==data.type){data.timeout=null;var that=this;data.checkForStall=function(){var self=this;this.active?(that.checkMediaSynchronization(),this.element.get(0).readyState>0&&!this.outOfSync?that.playbackStalled(!1,self):(that.playbackStalled(!0,self),this.timeout&&window.clearTimeout(this.timeout),this.timeout=window.setTimeout(function(){self.checkForStall()},1e3))):that.playbackStalled(!1,self)}}if(this._mediaElements.push(data),this.$playerElement){var targetElement=this.$playerElement.find(".canvasContainer");targetElement.append(mediaElement)}if("Video"==data.type||"Audio"==data.type){var self=data;mediaElement.on("loadstart",function(){self.checkForStall()}),mediaElement.on("waiting",function(){self.checkForStall()}),mediaElement.on("seeking",function(){}),mediaElement.attr("preload","auto"),mediaElement.get(0).load()}this._renderSyncIndicator(data)},CanvasInstance.prototype._renderSyncIndicator=function(mediaElementData){var leftPercent=this._convertToPercentage(mediaElementData.start,this.canvasClockDuration),widthPercent=this._convertToPercentage(mediaElementData.end-mediaElementData.start,this.canvasClockDuration),timelineItem=$('<div class="timelineItem" title="'+mediaElementData.source+'" data-start="'+mediaElementData.start+'" data-end="'+mediaElementData.end+'"></div>');timelineItem.css({left:leftPercent+"%",width:widthPercent+"%"});var lineWrapper=$('<div class="lineWrapper"></div>');if(timelineItem.appendTo(lineWrapper),mediaElementData.timelineElement=timelineItem,this.$playerElement){var itemContainer=this.$playerElement.find(".timelineItemContainer");itemContainer.append(lineWrapper)}},CanvasInstance.prototype.setCurrentTime=function(seconds){var secondsAsFloat=parseFloat(seconds);isNaN(secondsAsFloat)||(this.canvasClockTime=secondsAsFloat,this.canvasClockStartDate=Date.now()-1e3*this.canvasClockTime,this.logMessage("SET CURRENT TIME to: "+this.canvasClockTime+" seconds."),this.canvasClockUpdater(),this.highPriorityUpdater(),this.lowPriorityUpdater(),this.synchronizeMedia())},CanvasInstance.prototype.playCanvas=function(withoutUpdate){if(!this.isPlaying){this.canvasClockTime===this.canvasClockDuration&&(this.canvasClockTime=0),this.canvasClockStartDate=Date.now()-1e3*this.canvasClockTime;var self=this;this._highPriorityInterval=window.setInterval(function(){self.highPriorityUpdater()},this._highPriorityFrequency),this._lowPriorityInterval=window.setInterval(function(){self.lowPriorityUpdater()},this._lowPriorityFrequency),this._canvasClockInterval=window.setInterval(function(){self.canvasClockUpdater()},this._canvasClockFrequency),this.isPlaying=!0,withoutUpdate||this.synchronizeMedia(),this.logMessage("PLAY canvas")}},CanvasInstance.prototype.pauseCanvas=function(withoutUpdate){window.clearInterval(this._highPriorityInterval),window.clearInterval(this._lowPriorityInterval),window.clearInterval(this._canvasClockInterval),this.isPlaying=!1,withoutUpdate||(this.highPriorityUpdater(),this.lowPriorityUpdater(),this.synchronizeMedia()),this.logMessage("PAUSE canvas")},CanvasInstance.prototype.canvasClockUpdater=function(){this.canvasClockTime=(Date.now()-this.canvasClockStartDate)/1e3,this.canvasClockTime>=this.canvasClockDuration&&(this.canvasClockTime=this.canvasClockDuration,this.pauseCanvas())},CanvasInstance.prototype.highPriorityUpdater=function(){if(this.$playerElement){var $timeLineContainer=this.$playerElement.find(".timelineContainer");$timeLineContainer.slider({value:this.canvasClockTime}),this.$playerElement.find(".canvasTime").text(IIIFComponents.AVComponentUtils.Utils.formatTime(this.canvasClockTime))}},CanvasInstance.prototype.lowPriorityUpdater=function(){this.updateMediaActiveStates()},CanvasInstance.prototype.updateMediaActiveStates=function(){for(var mediaElement,i=0;i<this._mediaElements.length;i++)mediaElement=this._mediaElements[i],mediaElement.start<=this.canvasClockTime&&mediaElement.end>=this.canvasClockTime?(this.checkMediaSynchronization(),mediaElement.active||(this.synchronizeMedia(),mediaElement.active=!0,mediaElement.element.show(),mediaElement.timelineElement.addClass("active")),"Video"!=mediaElement.type&&"Audio"!=mediaElement.type||mediaElement.element[0].currentTime>mediaElement.element[0].duration-mediaElement.endOffset&&mediaElement.element[0].pause()):mediaElement.active&&(mediaElement.active=!1,mediaElement.element.hide(),mediaElement.timelineElement.removeClass("active"),"Video"!=mediaElement.type&&"Audio"!=mediaElement.type||mediaElement.element[0].pause())},CanvasInstance.prototype.synchronizeMedia=function(){for(var mediaElement,i=0;i<this._mediaElements.length;i++)if(mediaElement=this._mediaElements[i],"Video"==mediaElement.type||"Audio"==mediaElement.type){if(mediaElement.element[0].currentTime=this.canvasClockTime-mediaElement.start+mediaElement.startOffset,mediaElement.start<=this.canvasClockTime&&mediaElement.end>=this.canvasClockTime)if(this.isPlaying){if(mediaElement.element[0].paused){var promise=mediaElement.element[0].play();promise&&promise["catch"](function(){})}}else mediaElement.element[0].pause();else mediaElement.element[0].pause();mediaElement.element[0].currentTime>mediaElement.element[0].duration-mediaElement.endOffset&&mediaElement.element[0].pause()}this.logMessage("SYNC MEDIA at: "+this.canvasClockTime+" seconds.")},CanvasInstance.prototype.checkMediaSynchronization=function(){for(var mediaElement,i=0,l=this._mediaElements.length;i<l;i++)if(mediaElement=this._mediaElements[i],("Video"==mediaElement.type||"Audio"==mediaElement.type)&&mediaElement.start<=this.canvasClockTime&&mediaElement.end>=this.canvasClockTime){var correctTime=this.canvasClockTime-mediaElement.start+mediaElement.startOffset,factualTime=mediaElement.element[0].currentTime;if(Math.abs(factualTime-correctTime)>.4){mediaElement.outOfSync=!0;var lag=Math.abs(factualTime-correctTime);this.logMessage("DETECTED synchronization lag: "+Math.abs(lag)),mediaElement.element[0].currentTime=correctTime}else mediaElement.outOfSync=!1}},CanvasInstance.prototype.playbackStalled=function(aBoolean,syncMediaRequestingStall){if(aBoolean)this.stallRequestedBy.indexOf(syncMediaRequestingStall)<0&&this.stallRequestedBy.push(syncMediaRequestingStall),this.isStalled||(this.$playerElement&&this._showWorkingIndicator(this.$playerElement.find(".canvasContainer")),this.wasPlaying=this.isPlaying,this.pauseCanvas(!0),this.isStalled=aBoolean);else{var idx=this.stallRequestedBy.indexOf(syncMediaRequestingStall);idx>=0&&this.stallRequestedBy.splice(idx,1),0===this.stallRequestedBy.length&&(this._hideWorkingIndicator(),this.isStalled&&this.wasPlaying&&this.playCanvas(!0),this.isStalled=aBoolean)}},CanvasInstance.prototype._showWorkingIndicator=function($targetElement){var workingIndicator=$('<div class="workingIndicator">Waiting ...</div>');0==$targetElement.find(".workingIndicator").length&&$targetElement.append(workingIndicator)},CanvasInstance.prototype._hideWorkingIndicator=function(){$(".workingIndicator").remove()},CanvasInstance}();IIIFComponents.CanvasInstance=CanvasInstance}(IIIFComponents||(IIIFComponents={}));var IIIFComponents;!function(IIIFComponents){var AVComponentUtils;!function(AVComponentUtils){var Utils=function(){function Utils(){}return Utils.formatTime=function(aNumber){var hours,minutes,seconds,hourValue;return seconds=Math.ceil(aNumber),hours=Math.floor(seconds/3600),hours=hours>=10?hours:"0"+hours,minutes=Math.floor(seconds%3600/60),minutes=minutes>=10?minutes:"0"+minutes,seconds=Math.floor(seconds%3600%60),seconds=seconds>=10?seconds:"0"+seconds,hourValue=hours>=1?hours+":":"",hourValue+minutes+":"+seconds},Utils}();AVComponentUtils.Utils=Utils}(AVComponentUtils=IIIFComponents.AVComponentUtils||(IIIFComponents.AVComponentUtils={}))}(IIIFComponents||(IIIFComponents={}))}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1])(1)});